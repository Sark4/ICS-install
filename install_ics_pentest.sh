#!/bin/bash

# Script de configuration pour Kali Linux - Pentests ICS
# Ce script crée une hiérarchie de dossiers pour ICS et installe des outils de pentest ICS

# Définir le répertoire de base pour l'installation
BASE_DIR="/home/$(whoami)/Documents/ICS"
echo "Installation des outils dans $BASE_DIR"

# Création de la hiérarchie des dossiers
echo "Création de la hiérarchie de dossiers ICS..."
mkdir -p "$BASE_DIR"/{firmware,tools/{scan,honeypot,exploitation,analysis,protocol,log,lorawan,zigbee,fuzzing,radio,reverse,general},framework,logs,scans,reports}

# Mise à jour et installation de paquets de base (requiert sudo)
echo "Mise à jour du système et installation des paquets de base..."
sudo apt update && sudo apt upgrade -y
sudo apt install -y git wget python3-pip python3-venv scapy

# Créer et activer un environnement virtuel Python pour éviter les conflits de paquets système
python3 -m venv "$BASE_DIR/venv"
source "$BASE_DIR/venv/bin/activate"

# Installation des outils ICS spécifiques et organisation dans les dossiers thématiques
echo "Installation et organisation des outils ICS..."

# Outils d'analyse et de capture
sudo apt install -y wireshark
sudo cp /usr/bin/wireshark "$BASE_DIR/tools/analysis/"

sudo apt install -y intercepter-ng
sudo cp /usr/bin/intercepter-ng "$BASE_DIR/tools/analysis/"

# Outils de test de protocole
cd "$BASE_DIR/tools/protocol"
pip install pymodbus

# Installer mbtget pour scanner Modbus
sudo apt install -y mbtget
sudo cp /usr/bin/mbtget "$BASE_DIR/tools/protocol/"

# Outils pour les tests d'intrusion SCADA
git clone https://github.com/arnaudsoullie/SCADAPASS.git "$BASE_DIR/tools/scan/"
pip install -r "$BASE_DIR/tools/scan/SCADAPASS/requirements.txt"

git clone https://github.com/leonjza/PLCScan.git "$BASE_DIR/tools/scan/"
pip install -r "$BASE_DIR/tools/scan/PLCScan/requirements.txt"

# Nmap avec des scripts pour ICS
sudo apt install -y nmap
git clone https://github.com/vulnersCom/nmap-vulners.git "$BASE_DIR/tools/scan/nmap-vulners"

# Frameworks d'exploitation
sudo apt install -y metasploit-framework
sudo cp /usr/bin/msfconsole "$BASE_DIR/tools/exploitation/"

git clone https://github.com/aliasrobotics/RVD.git "$BASE_DIR/tools/exploitation/iot-scanner"
cd "$BASE_DIR/tools/exploitation/iot-scanner"
pip install -r requirements.txt

sudo apt install -y bettercap
sudo cp /usr/bin/bettercap "$BASE_DIR/tools/exploitation/"

git clone https://github.com/adi0x90/ICS-S7comm.git "$BASE_DIR/tools/exploitation/ICS-S7comm"
cd "$BASE_DIR/tools/exploitation/ICS-S7comm"
pip install -r requirements.txt

git clone https://github.com/dark-lbp/isf.git "$BASE_DIR/tools/exploitation/ISF-Schneider"
cd "$BASE_DIR/tools/exploitation/ISF-Schneider"
pip install -r requirements.txt

# Dossier log : Plaso pour analyse des journaux
cd "$BASE_DIR/tools/log"
sudo apt install -y python3-dev liblzma-dev libsnappy-dev
pip install plaso

# Dossier lorawan : ChirpOTLE pour LoRaWAN
git clone https://github.com/seemoo-lab/chirpOTLE.git "$BASE_DIR/tools/lorawan"
cd "$BASE_DIR/tools/lorawan"
pip install -r requirements.txt

# Dossier zigbee : KillerBee pour exploitation des réseaux Zigbee
git clone https://github.com/riverloopsec/killerbee.git "$BASE_DIR/tools/zigbee"
cd "$BASE_DIR/tools/zigbee"
sudo apt install -y python3-usb
pip install -r requirements.txt

# Dossier fuzzing : Fuzzowski pour tests de fuzzing
git clone https://github.com/nccgroup/fuzzowski.git "$BASE_DIR/tools/fuzzing"
cd "$BASE_DIR/tools/fuzzing"
pip install -r requirements.txt

# Dossier radio : gr-smart_meters pour communications radio
git clone https://github.com/BitBangingBytes/gr-smart_meters.git "$BASE_DIR/tools/radio"
cd "$BASE_DIR/tools/radio"
pip install -r requirements.txt

# Dossier reverse : Binwalk pour reverse engineering
git clone https://github.com/ReFirmLabs/binwalk.git "$BASE_DIR/tools/reverse"
cd "$BASE_DIR/tools/reverse"
sudo apt install -y binwalk

# Outils supplémentaires dans le dossier general
cd "$BASE_DIR/tools/general"

# Scapy est déjà installé en tant que paquet de base
git clone https://github.com/klsecservices/s7scan.git
git clone https://sourceforge.net/projects/snap7/files/ ~/Documents/ICS/tools/general/snap7
git clone https://github.com/yanlinlin82/plcscan.git
git clone https://github.com/moki-ics/modscan.git
git clone https://github.com/0x0mar/smod.git
git clone https://github.com/dark-lbp/isf.git "$BASE_DIR/tools/general/isf"

# Simulateurs et Honeypots
sudo apt install -y conpot
sudo cp /usr/bin/conpot "$BASE_DIR/tools/honeypot/"

# Outils d’analyse de firmware
cd "$BASE_DIR/firmware"
git clone https://github.com/attify/firmware-analysis-toolkit.git
pip install -r firmware-analysis-toolkit/requirements.txt

# Firmwalker pour analyse de firmware
git clone https://github.com/craigz28/firmwalker.git "$BASE_DIR/firmware/firmwalker"

# Communication avec les bus industriels
pip install python-snap7
git clone https://github.com/hydrabus/hydrabus.git "$BASE_DIR/tools/protocol/hydrabus"
cd "$BASE_DIR/tools/protocol/hydrabus" && make

# Désactiver l'environnement virtuel
deactivate

# Finalisation
echo "Installation des outils et organisation terminées."

# Vérification des installations
echo "Outils dans $BASE_DIR/tools :"
ls "$BASE_DIR/tools/"
echo "Frameworks dans $BASE_DIR/framework :"
ls "$BASE_DIR/framework/"
echo "Dossiers de firmware dans $BASE_DIR/firmware :"
ls "$BASE_DIR/firmware/"
echo "Structure de dossiers ICS complète et prête pour les pentests."

echo "Configuration prête pour les audits et pentests ICS."
