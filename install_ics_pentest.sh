#!/bin/bash

# Script de configuration pour Kali Linux - Pentests ICS
# Ce script crée une hiérarchie de dossiers pour ICS et installe des outils de pentest ICS

# Vérification des droits d'utilisateur
if [[ $EUID -ne 0 ]]; then
   echo "Ce script doit être exécuté en tant qu'administrateur" 
   exit 1
fi

# Définir le répertoire de base pour l'installation
BASE_DIR="/home/$(whoami)/Documents/ICS"
echo "Installation des outils dans $BASE_DIR"

# Création de la hiérarchie des dossiers
echo "Création de la hiérarchie de dossiers ICS..."
mkdir -p "$BASE_DIR"/{firmware,tools/{scan,honeypot,exploitation,analysis,protocol},framework,logs,scans,reports}

# Mise à jour et installation de paquets de base
echo "Mise à jour du système et installation des paquets de base..."
apt update && apt upgrade -y
apt install -y git wget python3-pip

# Installation des outils ICS spécifiques et organisation dans les dossiers thématiques
echo "Installation et organisation des outils ICS..."

# Outils d'analyse et de capture
apt install -y wireshark
mv /usr/bin/wireshark "$BASE_DIR/tools/analysis/"

apt install -y intercepter-ng
mv /usr/bin/intercepter-ng "$BASE_DIR/tools/analysis/"

# Outils de test de protocole
cd "$BASE_DIR/tools/protocol"
# Utilisation de PyModbus comme alternative à ModScan
pip3 install pymodbus

# Installer mbtget pour scanner Modbus
apt install -y mbtget
mv /usr/bin/mbtget "$BASE_DIR/tools/protocol/"

# Outils pour les tests d'intrusion SCADA
# SCADAPASS pour attaques brute-force sur SCADA
git clone https://github.com/arnaudsoullie/SCADAPASS.git "$BASE_DIR/tools/scan/"
pip3 install -r "$BASE_DIR/tools/scan/SCADAPASS/requirements.txt"

# PLCScan pour détection d'appareils PLC
git clone https://github.com/leonjza/PLCScan.git "$BASE_DIR/tools/scan/"
pip3 install -r "$BASE_DIR/tools/scan/PLCScan/requirements.txt"

# Nmap avec des scripts pour ICS
apt install -y nmap
# Utilisation de nmap-vulners comme alternative pour les scripts de vulnérabilité
git clone https://github.com/vulnersCom/nmap-vulners.git "$BASE_DIR/tools/scan/nmap-vulners"

# Frameworks d'exploitation
apt install -y metasploit-framework
mv /usr/bin/msfconsole "$BASE_DIR/tools/exploitation/"

# EXPLIoT pour les tests de pénétration IoT et SCADA
git clone https://github.com/ExpliotFramework/expliot.git "$BASE_DIR/tools/exploitation/expliot"
cd "$BASE_DIR/tools/exploitation/expliot"
pip3 install -r requirements.txt

# Simulateurs et Honeypots
apt install -y conpot
mv /usr/bin/conpot "$BASE_DIR/tools/honeypot/"

# Outils d’analyse de firmware
cd "$BASE_DIR/firmware"
git clone https://github.com/attify/firmware-analysis-toolkit.git
pip3 install -r firmware-analysis-toolkit/requirements.txt

# Firmwalker pour analyse de firmware
git clone https://github.com/craigz28/firmwalker.git "$BASE_DIR/firmware/firmwalker"

# Communication avec les bus industriels
# Snap7 pour interagir avec les automates Siemens S7
pip3 install python-snap7
mv /usr/local/lib/python*/dist-packages/snap7* "$BASE_DIR/tools/protocol/"

# Hydrabus pour interaction avec les bus industriels (I2C, SPI, etc.)
git clone https://github.com/hydrabus/hydrabus.git "$BASE_DIR/tools/protocol/hydrabus"
cd "$BASE_DIR/tools/protocol/hydrabus" && make

# Finalisation
echo "Installation des outils et organisation terminées."

# Vérification des installations
echo "Outils dans $BASE_DIR/tools :"
ls "$BASE_DIR/tools/"
echo "Frameworks dans $BASE_DIR/framework :"
ls "$BASE_DIR/framework/"
echo "Dossiers de firmware dans $BASE_DIR/firmware :"
ls "$BASE_DIR/firmware/"
echo "Structure de dossiers ICS complète et prête pour les pentests."

echo "Configuration prête pour les audits et pentests ICS."
